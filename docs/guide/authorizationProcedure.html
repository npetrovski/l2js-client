<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lineage 2 Authorization Procedure | Lineage 2 JavaScript Client</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="This project was made while experimenting with TypeScript and es6. The idea is to have an NCSoft Lineage 2 client library, that allows other projects to build L2 client functionalities (like bots, game helpers, etc.) on top of it. It can be also used as a framework for building Lineage2 automated tests for L2 private servers.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/l2js-client/assets/css/0.styles.8f4bea70.css" as="style"><link rel="preload" href="/l2js-client/assets/js/app.52acb91d.js" as="script"><link rel="preload" href="/l2js-client/assets/js/2.8a61e04c.js" as="script"><link rel="preload" href="/l2js-client/assets/js/12.c0c6ee60.js" as="script"><link rel="prefetch" href="/l2js-client/assets/js/10.44d58105.js"><link rel="prefetch" href="/l2js-client/assets/js/11.2f1cf44c.js"><link rel="prefetch" href="/l2js-client/assets/js/13.221ac7e4.js"><link rel="prefetch" href="/l2js-client/assets/js/14.946232d9.js"><link rel="prefetch" href="/l2js-client/assets/js/15.70e10e09.js"><link rel="prefetch" href="/l2js-client/assets/js/16.0b4568ad.js"><link rel="prefetch" href="/l2js-client/assets/js/17.6f9d0391.js"><link rel="prefetch" href="/l2js-client/assets/js/18.4c6dfb28.js"><link rel="prefetch" href="/l2js-client/assets/js/19.edc5d71b.js"><link rel="prefetch" href="/l2js-client/assets/js/20.50686fe6.js"><link rel="prefetch" href="/l2js-client/assets/js/21.9ed36b20.js"><link rel="prefetch" href="/l2js-client/assets/js/22.8764e1f2.js"><link rel="prefetch" href="/l2js-client/assets/js/3.1f1123e8.js"><link rel="prefetch" href="/l2js-client/assets/js/4.95ec17ab.js"><link rel="prefetch" href="/l2js-client/assets/js/5.7ec961d8.js"><link rel="prefetch" href="/l2js-client/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/l2js-client/assets/js/7.bbac9ad2.js"><link rel="prefetch" href="/l2js-client/assets/js/8.84a4a400.js"><link rel="prefetch" href="/l2js-client/assets/js/9.b78bc2bc.js">
    <link rel="stylesheet" href="/l2js-client/assets/css/0.styles.8f4bea70.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/l2js-client/" class="home-link router-link-active"><!----> <span class="site-name">Lineage 2 JavaScript Client</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/l2js-client/guide/" class="nav-link router-link-active">
  Docs
</a></div><div class="nav-item"><a href="https://github.com/npetrovski/l2js-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/l2js-client/guide/" class="nav-link router-link-active">
  Docs
</a></div><div class="nav-item"><a href="https://github.com/npetrovski/l2js-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/l2js-client/guide/" aria-current="page" class="sidebar-link">Supported L2 Chronicles</a></li><li><a href="/l2js-client/guide/installation.html" class="sidebar-link">Installation</a></li><li><a href="/l2js-client/guide/examples.html" class="sidebar-link">Examples</a></li><li><a href="/l2js-client/guide/api.html" class="sidebar-link">API</a></li><li><a href="/l2js-client/guide/authorizationProcedure.html" aria-current="page" class="active sidebar-link">Lineage 2 Authorization Procedure</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/l2js-client/guide/authorizationProcedure.html#general-information" class="sidebar-link">General Information</a></li><li class="sidebar-sub-header"><a href="/l2js-client/guide/authorizationProcedure.html#the-order-of-interaction-of-the-authorization-server-with-the-client" class="sidebar-link">The order of interaction of the authorization server with the client</a></li><li class="sidebar-sub-header"><a href="/l2js-client/guide/authorizationProcedure.html#sending-packets-by-the-authorization-server" class="sidebar-link">Sending packets by the authorization server.</a></li></ul></li><li><a href="/l2js-client/guide/protocolOverview.html" class="sidebar-link">Protocol Overview</a></li><li><a href="/l2js-client/guide/loginProtocol.html" class="sidebar-link">Login (Auth) Protocol</a></li><li><a href="/l2js-client/guide/gameProtocol.html" class="sidebar-link">Game Protocol</a></li><li><a href="/l2js-client/guide/todo.html" class="sidebar-link">To-Do List</a></li><li><a href="/l2js-client/guide/contributing.html" class="sidebar-link">Contributing</a></li><li><a href="/l2js-client/guide/community.html" class="sidebar-link">Community</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="lineage-2-authorization-procedure"><a href="#lineage-2-authorization-procedure" class="header-anchor">#</a> Lineage 2 Authorization Procedure</h1> <blockquote><p>Two servers - an <code>authorization server</code> and a <code>game server</code>. Each of them encrypts packets for the client in a slightly different way.</p></blockquote> <h2 id="general-information"><a href="#general-information" class="header-anchor">#</a> General Information</h2> <ul><li>Packets are byte arrays</li> <li>Bytes arrive and are written in the reverse order to a TCP socket (see Little Endian)</li> <li>Packets consist of length (2 bytes), packet type (1 byte) and content (any number of bytes)</li> <li>The contents of the packet will be called the data transmitted in the packet (keys, session ID, etc.), excluding the length and type of packet</li> <li>The length of the packet is not encrypted and is not taken into account when calculating the checksum, since it is calculated after. The type of package, as well as the contents, is taken into account when calculating the checksum. The packet type, contents and checksum are encrypted together using the Blowfish algorithm.</li> <li>Packet Length - A number indicating the length of the entire packet. In other words, it also includes the length of the encrypted data (which consists of the contents and type of the packet, the checksum and is encrypted using the Blowfish algorithm) and two bytes for the number itself, indicating the length</li> <li>Blowfish is a block cipher algorithm that processes blocks of 8 bytes each, which means that the length of the contents of the packet together with the type and checksum must be a multiple of 8 (for this, the checksum is beaten from the contents of the packet with the required number of zeros)</li> <li>Please note that depending on whether you collect the package in advance in Little Endian order or later deploy the encryption and checksum calculation algorithms, respectively, it will be different.
This may be important if, for example, the library selected for your programming language Blowfish can only encrypt bytes in direct order (Big Endian)</li></ul> <h2 id="the-order-of-interaction-of-the-authorization-server-with-the-client"><a href="#the-order-of-interaction-of-the-authorization-server-with-the-client" class="header-anchor">#</a> The order of interaction of the authorization server with the client</h2> <p>For convenience, I'll denote by the prefix <code>S</code> packets sent by the server, and <code>C</code> - sent by the client, because they can have the same ID, but different contents</p> <blockquote><p>S / 0x00 (Init) packet is not signed by the checksum, all other packets are signed by</p></blockquote> <blockquote><p>S / 0x00 (Init) is encrypted using the XOR algorithm, all other packets are not encrypted.</p></blockquote> <p>All packets are encrypted using the Blowfish algorithm with a key randomly generated for each connection and sent in the S / 0x00 (Init) packet, except for the S / 0x00 (Init) packet which is encrypted with a key invented by the developers of the game (wired in the client)</p> <p>Encryption using the Blowfish algorithm is always the last, i.e.:</p> <div class="language-meta extra-class"><pre class="language-text"><code># S / 0x00 packet encryption (Init)
data = xor.encrypt (data)
data = blowfish.encrypt (data, STATIC_KEY)

# Encryption of any other package
data = checksum.sign (data)
data = blowfish.encrypt (data, SESSION_KEY)
</code></pre></div><p>Decryption always goes the same:</p> <div class="language-meta extra-class"><pre class="language-text"><code># Decryption of any incoming packet
data = blowfish.decrypt (data, SESSION_KEY)
data = checksum.verify (data)
</code></pre></div><p>The contents of the C / 0x00 packet (RequestAuthLogin) comes with the RSA encrypted algorithm using the key that the server sends in the S / 0x00 (Init) packet. Only content is encrypted, but not the length or type of the packet. The packet itself is encrypted as usual. The content is encrypted additionally, as contains login and password</p> <p>Interaction procedure for successful authorization:</p> <ol><li><em>User initializes the client with login and password</em></li> <li>Client connects to a server (default socket port 2106)</li> <li>Server sends <code>S / 0x00</code> packet (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/Init.ts" target="_blank" rel="noopener noreferrer">Init<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>Client sends <code>C / 0x07</code> packet (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/AuthGameGuard.ts" target="_blank" rel="noopener noreferrer">AuthGameGuard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>Server sends <code>S / 0x0b</code> packet (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/GGAuth.ts" target="_blank" rel="noopener noreferrer">GGAuth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>Client sends username and password in <code>C / 0x00</code> packet (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/RequestAuthLogin.ts" target="_blank" rel="noopener noreferrer">RequestAuthLogin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>The server checks the username and password and sends <code>S / 0x03</code> (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/LoginOk.ts" target="_blank" rel="noopener noreferrer">LoginOk<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>The client requests a list of game servers with the <code>C / 0x05</code> package (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/RequestServerList.ts" target="_blank" rel="noopener noreferrer">RequestServerList<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>The server sends a list of game servers in the <code>S / 0x04</code> package (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/ServerList.ts" target="_blank" rel="noopener noreferrer">ServerList<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>The client selects a server from the list, and sends a <code>C / 0x02</code> packet (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/clientpackets/RequestServerLogin.ts" target="_blank" rel="noopener noreferrer">RequestServerLogin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li> <li>Server sends packet <code>S / 0x07</code> (<a href="https://github.com/npetrovski/l2js-client/blob/master/src/network/serverpackets/PlayOk.ts" target="_blank" rel="noopener noreferrer">PlayOK<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</li></ol> <p>Next, the client disconnects from the authorization server and connects to the game server.</p> <h2 id="sending-packets-by-the-authorization-server"><a href="#sending-packets-by-the-authorization-server" class="header-anchor">#</a> Sending packets by the authorization server.</h2> <p>Packets are written as an array of bytes:</p> <ol><li>Write 1 byte of packet type, for example, 0x00</li> <li>We form and add the contents of the package (session ID, server version, keys, zero-byte of Blowfish key end, etc.)</li> <li>We calculate the checksum for the current byte array</li> <li>We achieve the length of the current byte array with zero bytes up to a multiple of 8</li> <li>Add the checksum to the array</li> <li>We encrypt the current byte array using the Blowfish algorithm</li> <li>Calculate the length of the resulting array</li> <li>We add to the value of length 2 to take into account the two bytes of length themselves</li> <li>Add the length to the beginning of the array</li></ol> <p><em>From a TCP socket, bytes should be read in reverse order.</em></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/l2js-client/guide/api.html" class="prev">
        API
      </a></span> <span class="next"><a href="/l2js-client/guide/protocolOverview.html">
        Protocol Overview
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/l2js-client/assets/js/app.52acb91d.js" defer></script><script src="/l2js-client/assets/js/2.8a61e04c.js" defer></script><script src="/l2js-client/assets/js/12.c0c6ee60.js" defer></script>
  </body>
</html>
